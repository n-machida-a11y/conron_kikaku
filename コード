/**
 * Webアプリのメインエントリーポイント
 */
function doGet(e) {
  return HtmlService.createTemplateFromFile("index")
    .evaluate()
    .setTitle("ナカノ企画書") 
    .addMetaTag("viewport", "width=device-width, initial-scale=1.0");
}

/**
 * 画像URLマップを作成する (Base64データを取得するため、キャッシュは利用しない)
 * シート名: 絵型 (旧: 写真)
 */
function getImageUrlMap() {


  Logger.log("画像URLマップの再構築を開始します (キャッシュ不使用)...");
  const imageUrlMap = {};
  
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const photoSheet = ss.getSheetByName("絵型");
    if (!photoSheet) {
      Logger.log("シート「絵型」が見つかりませんでした。");
      return {};
    }
    
    const photoLastRow = photoSheet.getLastRow();
    if (photoLastRow < 2) return {};
    
    const photoValues = photoSheet.getRange(2, 1, photoLastRow - 1, 4).getValues(); 
    
    let imageFolderName = null;
    // D列 (Path) からフォルダ名（例: '絵型_Images'）を抽出
    for (const row of photoValues) {
      const path = row[3]; 
      if (path && typeof path === 'string' && path.includes('/')) {
        imageFolderName = path.split('/')[0];
        break;
      }
    }

    if (!imageFolderName) {
      Logger.log("画像フォルダ名が特定できませんでした。");
      return {};
    }
    
    Logger.log(`特定された画像フォルダ名: ${imageFolderName}`);
    
    // フォルダ検索ロジック (変更なし)
    let imageFolder = null;
    try {
      const ssFile = DriveApp.getFileById(ss.getId());
      const parents = ssFile.getParents();
      while (parents.hasNext()) {
        const parent = parents.next();
        const folders = parent.getFoldersByName(imageFolderName);
        if (folders.hasNext()) {
          imageFolder = folders.next();
          Logger.log(`成功: Spreadsheetと同じ階層に画像フォルダ "${imageFolderName}" を発見しました。`);
          break;
        }
      }
    } catch (e) {
      Logger.log("親フォルダ検索エラー: " + e.message);
    }

    if (!imageFolder) {
      Logger.log("親階層に見つからないため、ドライブ全体から検索します。");
      const folders = DriveApp.getFoldersByName(imageFolderName);
      if (folders.hasNext()) {
        imageFolder = folders.next();
        Logger.log(`成功: ドライブ全体から画像フォルダ "${imageFolderName}" を発見しました。`);
      }
    }

    if (!imageFolder) {
       Logger.log(`失敗: 画像フォルダ "${imageFolderName}" が見つかりません。`);
       return {};
    }
    
    const files = imageFolder.getFiles();
    
    while (files.hasNext()) {
      const file = files.next();
      const fileName = file.getName();
      
      // ファイル名の先頭部分をキーとして使用 (例: 79ae950e)
      let idPart = null;
      const parts = fileName.split('.');
      if (parts.length > 0) {
          idPart = parts[0].trim();
      }

      if (idPart) {
          // ★修正: ファイルのBase64データとMIMEタイプを取得する
          try {
             const bytes = file.getBlob().getBytes();
             const base64Data = Utilities.base64Encode(bytes);
             const mimeType = file.getMimeType();
             
             imageUrlMap[idPart] = {
                 id: file.getId(), 
                 data: `data:${mimeType};base64,${base64Data}` 
             };
             
             // ★デバッグログ出力は維持
             const debugData = base64Data.substring(0, 100) + '...';
             Logger.log(`マップ登録 (Base64): キー "${idPart}" MIME: ${mimeType} データ先頭: ${debugData}`);
             
          } catch(e) {
             // getBlob()自体が失敗した場合はここにくる
             Logger.log(`Base64変換エラー (${fileName}): ${e.message}`);
          }
      }
    }

    // cache.put(CACHE_KEY, JSON.stringify(imageUrlMap), CACHE_TIMEOUT_SECONDS); // キャッシュ処理を削除
    return imageUrlMap; // 成功したマップをそのまま返す

  } catch (err) {
    // フォルダ検索など、致命的なエラーのみをここでキャッチ
    Logger.log("getImageUrlMap (FATAL) Error: " + err.message);
    return {};
  }
}

/**
 * 商品データを取得する
 */
function getProductData() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    
    // シート名と取得
    const kikakuSheet = ss.getSheetByName("企画管理");
    const colorSheet = ss.getSheetByName("カラー");
    const sizeSheet = ss.getSheetByName("サイズ");
    const photoSheet = ss.getSheetByName("絵型");
    // const fabricSheet は不要

    // 必須シートの存在チェック
    if (!kikakuSheet) {
      throw new Error("スプレッドシート内に「企画管理」シートが見つかりませんでした。");
    }
    
    // データ最終行の取得
    const kikakuLastRow = kikakuSheet.getLastRow();
    // 必須ではないシートは、存在しない場合は空の配列で代用できるように調整
    const colorLastRow = colorSheet ? colorSheet.getLastRow() : 1;
    const sizeLastRow = sizeSheet ? sizeSheet.getLastRow() : 1;
    const photoLastRow = photoSheet ? photoSheet.getLastRow() : 1;

    // 企画管理の列数を15列に更新
    const KIKAKU_MAX_COL = 15; 
    const kikakuValues = (kikakuLastRow > 1) ? kikakuSheet.getRange(2, 1, kikakuLastRow - 1, KIKAKU_MAX_COL).getValues() : [];
    
    // データ取得（シートが存在しない場合は空の配列を返す）
    const colorValues = (colorLastRow > 1 && colorSheet) ? colorSheet.getRange(2, 1, colorLastRow - 1, 3).getValues() : [];
    const sizeValues = (sizeLastRow > 1 && sizeSheet) ? sizeSheet.getRange(2, 1, sizeLastRow - 1, 2).getValues() : [];
    const photoValues = (photoLastRow > 1 && photoSheet) ? photoSheet.getRange(2, 1, photoLastRow - 1, 4).getValues() : [];

    // Base64データを含むマップを取得
    const imageBase64Map = getImageUrlMap();

    // 新しい企画管理の列定義に基づくマッピング (0-indexed)
    // [管理ID(0), 仮品番(1), 定番/外注(2), 品番(3), 品名(4), シーズン(5), ブランド(6), カテゴリー(7), サイズ(8),
    // 上代(9), 下代(10), 生地番号(11), 生地名(12), 進捗(13), 仕様書担当者(14)]
    const KIKAKU_MAP = {
      kanriId: 0,       // 管理ID
      kariHinban: 1,    // 仮品番 (インデックス 1)
      shinchoku: 13,    // 進捗 (13)
      hinban: 3,        // 品番 (商品IDとして使用)
      hinmei: 4,        // 品名
      season: 5,        // シーズン
      category: 7,      // カテゴリー
      jodai: 9,         // 上代 (9)
      gedai: 10,        // 下代 (10)
      fabric_number: 11, // 生地番号 (11)
      material_name: 12  // 生地名 (12)
    };
    
    // [カラー番号, 管理ID, カラー名]
    const COLOR_MAP = { 
      kanriId: 1,       // 管理ID (B列)
      colorName: 2      // カラー名 (C列)
    }; 
    
    // [管理ID, サイズ名] (変更なしと仮定)
    const SIZE_MAP = { kanriId: 0, size: 1 }; 

    // [絵型ID, 管理ID, タイトル, 写真(Path)]
    const PHOTO_MAP = { 
      kanriId: 1,       // 管理ID (B列)
      shashinId: 0      // 絵型ID (A列, 画像ファイルIDのキーとして使用)
    };
    
    // FABRIC_MAPは不要

    // --- マップ作成 (カラー) ---
    const colorsMap = colorValues.reduce((acc, row) => {
      const id = row[COLOR_MAP.kanriId];
      if (id) {
        if (!acc[id]) acc[id] = [];
        acc[id].push(row[COLOR_MAP.colorName]);
      }
      return acc;
    }, {});

    // --- マップ作成 (サイズ) --- (ロジック変更なし)
    const sizesMap = sizeValues.reduce((acc, row) => {
      const id = row[SIZE_MAP.kanriId];
      if (id) {
        if (!acc[id]) acc[id] = [];
        acc[id].push(row[SIZE_MAP.size]);
      }
      return acc;
    }, {});

    // --- マップ作成 (絵型/写真) ---
    const photosMap = photoValues.reduce((acc, row) => {
      const id = row[PHOTO_MAP.kanriId];           // B列: 管理ID
      const shashinId = row[PHOTO_MAP.shashinId];   // A列: 絵型ID (ファイルID部分)
      
      const cleanShashinId = shashinId ? String(shashinId).trim() : "";
      
      if (id && cleanShashinId) {
        if (!acc[id]) acc[id] = [];
        if (!acc[id].includes(cleanShashinId)) {
            acc[id].push(cleanShashinId);
        }
      }
      return acc;
    }, {});

    // --- データ組み立て ---
    const productData = [];
    
    const cleanPrice = (v) => {
      if (typeof v === 'number') return v;
      if (typeof v === 'string') return parseFloat(v.replace(/[¥,]/g, '')) || 0;
      return 0;
    };
    
    // const placeholderUrl = "https://placehold.co/400x400/f3f4f6/9ca3af?text=No+Image"; // 削除

    for (const row of kikakuValues) {
      const kanriId = row[KIKAKU_MAP.kanriId];
      if (!kanriId) continue;

      // const fabricInfo = fabricsMap[kanriId] || {}; // 削除
      
      const shashinIds = photosMap[kanriId] || [];
      const imageSources = []; // Base64データのみを格納

      if (shashinIds.length > 0) {
        shashinIds.forEach(sid => {
            // Base64データを取得
            const fileData = imageBase64Map[sid]; 
            if (fileData && fileData.data) {
                imageSources.push(fileData.data);
            } else {
                // Base64データがない場合は何も追加しない (プレースホルダーを挿入しない)
                Logger.log(`警告: 管理ID ${kanriId} (絵型ID ${sid}) のBase64データが見つからないか、変換に失敗しました。`); 
            }
        });
      }
      
      // ★修正: 画像がない場合のプレースホルダー挿入ロジックを削除
      // if (imageSources.length === 0) {
      //   imageSources.push(placeholderUrl);
      // }

      const product = {
        id: row[KIKAKU_MAP.hinban] || kanriId,
        kanriId: kanriId, 
        category: row[KIKAKU_MAP.category] || "N/A",
        season: row[KIKAKU_MAP.season] || "N/A",
        name: row[KIKAKU_MAP.hinmei] || "（品名未設定）",
        status: row[KIKAKU_MAP.shinchoku] || "N/A",
        colors: colorsMap[kanriId] || [],
        
        // 上代・下代を取得
        price_retail: cleanPrice(row[KIKAKU_MAP.jodai]),
        price_wholesale: cleanPrice(row[KIKAKU_MAP.gedai]),
        
        // 生地情報を企画管理シートから直接取得 (インデックス 11, 12)
        material_name: row[KIKAKU_MAP.material_name] || "N/A",
        // composition (混率) はN/Aに固定
        composition: "N/A", 
        sizes: sizesMap[kanriId] || [],
        fabric_number: row[KIKAKU_MAP.fabric_number] || "N/A", // 生地番号(11)
        
        // 仮品番をデータに含める
        kariHinban: row[KIKAKU_MAP.kariHinban] || "",
        
        // Base64データを画像ソースとして渡す
        images: imageSources, 
        imageUrl: imageSources[0] 
      };
      
      productData.push(product);
    }

    return productData;

  } catch (err) {
    // throw Errorの場合も、ここでフロントエンドに返す
    Logger.log("Error in getProductData: " + err);
    return { error: `データの読み込み中にエラーが発生しました: ${err.message}` };
  }
}
