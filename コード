/**
 * Webアプリのメインエントリーポイント
 */
function doGet(e) {
  return HtmlService.createTemplateFromFile("index")
    .evaluate()
    .setTitle("ナカノ企画書") 
    .addMetaTag("viewport", "width=device-width, initial-scale=1.0");
}

/**
 * 画像URLマップを作成する (Base64データを取得するため、キャッシュは利用しない)
 * シート名: 絵型 (旧: 写真)
 */
function getImageUrlMap() {
  Logger.log("画像URLマップの再構築を開始します (キャッシュ不使用)...");
  const imageUrlMap = {};
  
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const photoSheet = ss.getSheetByName("絵型");
    if (!photoSheet) {
      Logger.log("シート「絵型」が見つかりませんでした。");
      return {};
    }
    
    const photoLastRow = photoSheet.getLastRow();
    if (photoLastRow < 2) return {};
    
    const photoValues = photoSheet.getRange(2, 1, photoLastRow - 1, 4).getValues(); 
    
    let imageFolderName = null;
    // D列 (Path) からフォルダ名（例: '絵型_Images'）を抽出
    for (const row of photoValues) {
      const path = row[3]; 
      if (path && typeof path === 'string' && path.includes('/')) {
        imageFolderName = path.split('/')[0];
        break;
      }
    }

    if (!imageFolderName) {
      Logger.log("画像フォルダ名が特定できませんでした。");
      return {};
    }
    
    Logger.log(`特定された画像フォルダ名: ${imageFolderName}`);
    
    // フォルダ検索ロジック
    let imageFolder = findFolder(imageFolderName);

    if (!imageFolder) {
       Logger.log(`失敗: 画像フォルダ "${imageFolderName}" が見つかりません。`);
       return {};
    }
    
    const files = imageFolder.getFiles();
    while (files.hasNext()) {
      const file = files.next();
      const fileName = file.getName();
      let idPart = fileName.split('.')[0].trim();

      if (idPart) {
          try {
             const bytes = file.getBlob().getBytes();
             const base64Data = Utilities.base64Encode(bytes);
             const mimeType = file.getMimeType();
             
             imageUrlMap[idPart] = {
                 id: file.getId(), 
                 data: `data:${mimeType};base64,${base64Data}` 
             };
          } catch(e) {
             Logger.log(`Base64変換エラー (${fileName}): ${e.message}`);
          }
      }
    }
    return imageUrlMap;

  } catch (err) {
    Logger.log("getImageUrlMap (FATAL) Error: " + err.message);
    return {};
  }
}

// フォルダ検索ヘルパー
function findFolder(folderName) {
  try {
    const ssId = SpreadsheetApp.getActiveSpreadsheet().getId();
    const ssFile = DriveApp.getFileById(ssId);
    const parents = ssFile.getParents();
    while (parents.hasNext()) {
      const parent = parents.next();
      const folders = parent.getFoldersByName(folderName);
      if (folders.hasNext()) return folders.next();
    }
    // 親に見つからなければ全体検索
    const folders = DriveApp.getFoldersByName(folderName);
    if (folders.hasNext()) return folders.next();
  } catch (e) {
    console.error(e);
  }
  return null;
}

/**
 * 商品データを取得する
 */
function getProductData() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    
    const kikakuSheet = ss.getSheetByName("企画管理");
    const colorSheet = ss.getSheetByName("カラー");
    const sizeSheet = ss.getSheetByName("サイズ");
    const photoSheet = ss.getSheetByName("絵型");
    
    if (!kikakuSheet) throw new Error("スプレッドシート内に「企画管理」シートが見つかりませんでした。");
    
    const kikakuLastRow = kikakuSheet.getLastRow();
    const colorLastRow = colorSheet ? colorSheet.getLastRow() : 1;
    const sizeLastRow = sizeSheet ? sizeSheet.getLastRow() : 1;
    const photoLastRow = photoSheet ? photoSheet.getLastRow() : 1;

    const KIKAKU_MAX_COL = 16; 
    const kikakuValues = (kikakuLastRow > 1) ? kikakuSheet.getRange(2, 1, kikakuLastRow - 1, KIKAKU_MAX_COL).getValues() : [];
    const colorValues = (colorLastRow > 1 && colorSheet) ? colorSheet.getRange(2, 1, colorLastRow - 1, 3).getValues() : [];
    const sizeValues = (sizeLastRow > 1 && sizeSheet) ? sizeSheet.getRange(2, 1, sizeLastRow - 1, 2).getValues() : [];
    const photoValues = (photoLastRow > 1 && photoSheet) ? photoSheet.getRange(2, 1, photoLastRow - 1, 4).getValues() : [];

    const imageBase64Map = getImageUrlMap();

    // カラーマスタ画像データの取得
    const colorImages = getColorMasterData();

    const KIKAKU_MAP = {
      kanriId: 0, kariHinban: 1, shinchoku: 13, hinban: 3, hinmei: 4, 
      season: 5, category: 7, jodai: 9, gedai: 10, fabric_number: 11, material_name: 12
    };
    const COLOR_MAP = { kanriId: 1, colorName: 2 }; 
    const SIZE_MAP = { kanriId: 0, size: 1 }; 
    const PHOTO_MAP = { kanriId: 1, shashinId: 0 };
    
    const colorsMap = colorValues.reduce((acc, row) => {
      const id = row[COLOR_MAP.kanriId];
      if (id) {
        if (!acc[id]) acc[id] = [];
        acc[id].push(row[COLOR_MAP.colorName]);
      }
      return acc;
    }, {});

    const sizesMap = sizeValues.reduce((acc, row) => {
      const id = row[SIZE_MAP.kanriId];
      if (id) {
        if (!acc[id]) acc[id] = [];
        acc[id].push(row[SIZE_MAP.size]);
      }
      return acc;
    }, {});

    const photosMap = photoValues.reduce((acc, row) => {
      const id = row[PHOTO_MAP.kanriId];
      const shashinId = row[PHOTO_MAP.shashinId];
      const cleanShashinId = shashinId ? String(shashinId).trim() : "";
      if (id && cleanShashinId) {
        if (!acc[id]) acc[id] = [];
        if (!acc[id].includes(cleanShashinId)) acc[id].push(cleanShashinId);
      }
      return acc;
    }, {});

    const productData = [];
    const cleanPrice = (v) => {
      if (typeof v === 'number') return v;
      if (typeof v === 'string') return parseFloat(v.replace(/[¥,]/g, '')) || 0;
      return 0;
    };
    
    for (const row of kikakuValues) {
      const kanriId = row[KIKAKU_MAP.kanriId];
      if (!kanriId) continue;

      const shashinIds = photosMap[kanriId] || [];
      const imageSources = [];

      if (shashinIds.length > 0) {
        shashinIds.forEach(sid => {
            const fileData = imageBase64Map[sid]; 
            if (fileData && fileData.data) imageSources.push(fileData.data);
        });
      }
      
      const product = {
        id: row[KIKAKU_MAP.hinban] || kanriId,
        kanriId: kanriId, 
        category: row[KIKAKU_MAP.category] || "N/A",
        season: row[KIKAKU_MAP.season] || "N/A",
        name: row[KIKAKU_MAP.hinmei] || "（品名未設定）",
        status: row[KIKAKU_MAP.shinchoku] || "N/A",
        colors: colorsMap[kanriId] || [],
        price_retail: cleanPrice(row[KIKAKU_MAP.jodai]),
        price_wholesale: cleanPrice(row[KIKAKU_MAP.gedai]),
        material_name: row[KIKAKU_MAP.material_name] || "N/A",
        composition: "N/A",
        inseam: "",
        sizes: sizesMap[kanriId] || [],
        fabric_number: row[KIKAKU_MAP.fabric_number] || "N/A",
        kariHinban: row[KIKAKU_MAP.kariHinban] || "",
        images: imageSources, 
        imageUrl: imageSources[0] 
      };
      productData.push(product);
    }

    return { products: productData, colorImages: colorImages };

  } catch (err) {
    Logger.log("Error in getProductData: " + err);
    return { error: `データの読み込み中にエラーが発生しました: ${err.message}` };
  }
}

/**
 * カラーマスタから画像データを取得する
 */
function getColorMasterData() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("カラーマスタ");
  if (!sheet) return {};
  
  const lastRow = sheet.getLastRow();
  if (lastRow < 2) return {};
  
  const data = sheet.getRange(2, 1, lastRow - 1, 3).getValues();
  const colorMap = {};
  
  const folder = findFolder("ColorMaster_Images");
  if(!folder) return {};

  data.forEach(row => {
    const colorName = row[1];
    const fileId = row[2];
    if (colorName && fileId) {
       try {
         const file = DriveApp.getFileById(fileId);
         const blob = file.getBlob();
         const b64 = Utilities.base64Encode(blob.getBytes());
         colorMap[colorName] = `data:${blob.getMimeType()};base64,${b64}`;
       } catch(e) {
         console.log(`カラー画像取得エラー(${colorName}): ${e.message}`);
       }
    }
  });
  
  return colorMap;
}

/**
 * カラー画像をアップロードしてカラーマスタに保存する
 * 修正: 既存のカラー名があれば上書き更新し、行を増やさない
 */
function uploadColorImage(colorName, base64Data) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let sheet = ss.getSheetByName("カラーマスタ");
    if (!sheet) {
      sheet = ss.insertSheet("カラーマスタ");
      sheet.appendRow(["カラーマスタID", "カラー名", "色画像(FileID)"]);
    }
    
    // フォルダ確保
    const FOLDER_NAME = "ColorMaster_Images";
    let folder = findFolder(FOLDER_NAME);
    if (!folder) {
      folder = DriveApp.createFolder(FOLDER_NAME);
    }
    
    // Base64デコードしてファイル作成
    const contentType = base64Data.substring(5, base64Data.indexOf(';'));
    const bytes = Utilities.base64Decode(base64Data.substr(base64Data.indexOf('base64,') + 7));
    const blob = Utilities.newBlob(bytes, contentType, `${colorName}_swatch.png`);
    
    const file = folder.createFile(blob);
    const fileId = file.getId();
    
    // 重複チェックと上書き処理
    const lastRow = sheet.getLastRow();
    let updated = false;
    
    if (lastRow > 1) {
      // B列(カラー名)を取得
      const colorNames = sheet.getRange(2, 2, lastRow - 1, 1).getValues().flat();
      const rowIndex = colorNames.indexOf(colorName);
      
      if (rowIndex !== -1) {
        // 既存行が見つかった場合、C列(画像ID)を更新 (データ範囲は2行目からなので +2)
        sheet.getRange(rowIndex + 2, 3).setValue(fileId);
        updated = true;
      }
    }
    
    // 新規の場合のみ行を追加
    if (!updated) {
      const id = Utilities.getUuid();
      sheet.appendRow([id, colorName, fileId]);
    }
    
    return { success: true, fileId: fileId };
    
  } catch (e) {
    return { error: e.toString() };
  }
}
